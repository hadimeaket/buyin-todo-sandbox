name: Performance Testing

on:
  schedule:
    # Run performance tests every night
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        type: choice
        options:
          - staging
          - production
      duration:
        description: 'Test duration in seconds'
        required: false
        default: '300'

jobs:
  load-test:
    name: Load Testing with k6
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Create k6 test script
        run: |
          cat > load-test.js << 'EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';
          import { Rate } from 'k6/metrics';

          export let errorRate = new Rate('errors');

          export let options = {
            stages: [
              { duration: '30s', target: 10 },  // Ramp up
              { duration: '1m', target: 50 },   // Stay at 50 users
              { duration: '30s', target: 100 }, // Spike to 100
              { duration: '1m', target: 100 },  // Stay at 100
              { duration: '30s', target: 0 },   // Ramp down
            ],
            thresholds: {
              http_req_duration: ['p(95)<500', 'p(99)<1000'],
              http_req_failed: ['rate<0.01'],
              errors: ['rate<0.1'],
            },
          };

          const BASE_URL = __ENV.BASE_URL || 'http://localhost:4000';

          export default function () {
            // Test health endpoint
            let healthRes = http.get(`${BASE_URL}/api/health`);
            check(healthRes, {
              'health check status is 200': (r) => r.status === 200,
            }) || errorRate.add(1);

            sleep(1);

            // Test get all todos
            let todosRes = http.get(`${BASE_URL}/api/todos`);
            check(todosRes, {
              'todos status is 200': (r) => r.status === 200,
              'response time < 500ms': (r) => r.timings.duration < 500,
            }) || errorRate.add(1);

            sleep(1);

            // Test create todo
            let payload = JSON.stringify({
              title: `Test Todo ${Date.now()}`,
              description: 'Load test todo',
              priority: 'medium',
            });

            let params = {
              headers: { 'Content-Type': 'application/json' },
            };

            let createRes = http.post(`${BASE_URL}/api/todos`, payload, params);
            check(createRes, {
              'create status is 201': (r) => r.status === 201,
            }) || errorRate.add(1);

            sleep(2);
          }
          EOF

      - name: Run load test
        run: |
          k6 run --out json=results.json load-test.js
        env:
          BASE_URL: ${{ github.event.inputs.environment == 'production' && 'https://your-app.com' || 'https://staging.your-app.com' }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: k6-results
          path: results.json

      - name: Analyze results
        run: |
          echo "Performance test completed"
          # Parse results and fail if thresholds not met

  lighthouse-audit:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.5'

      - name: Install Lighthouse
        run: npm install -g @lhci/cli@0.12.x

      - name: Run Lighthouse CI
        run: |
          lhci autorun --upload.target=temporary-public-storage
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results
          path: .lighthouseci
