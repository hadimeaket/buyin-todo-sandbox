name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'release/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - development
          - staging
          - production

# Environment variables
env:
  NODE_VERSION: '20.19.5'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

# Concurrency control - cancel in-progress runs for the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =============================================================================
  # CODE QUALITY & SECURITY CHECKS
  # =============================================================================
  
  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [backend, frontend]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ matrix.service }}/package-lock.json

      - name: Install dependencies
        working-directory: ./${{ matrix.service }}
        run: npm ci --prefer-offline --no-audit

      - name: Run linter
        working-directory: ./${{ matrix.service }}
        run: npm run lint || echo "Linter not configured"
        continue-on-error: false

      - name: Check code formatting
        working-directory: ./${{ matrix.service }}
        run: |
          if grep -q "prettier" package.json; then
            npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,scss}"
          else
            echo "Prettier not configured, skipping"
          fi
        continue-on-error: true

      - name: TypeScript type checking
        working-directory: ./${{ matrix.service }}
        run: npx tsc --noEmit

      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-results-${{ matrix.service }}
          path: ./${{ matrix.service }}/**/*.log
          if-no-files-found: ignore

  # =============================================================================
  # SECURITY SCANNING
  # =============================================================================
  
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Dependency vulnerability scanning
      - name: Run npm audit (Backend)
        working-directory: ./backend
        run: |
          npm audit --audit-level=moderate || echo "Vulnerabilities found"
        continue-on-error: true

      - name: Run npm audit (Frontend)
        working-directory: ./frontend
        run: |
          npm audit --audit-level=moderate || echo "Vulnerabilities found"
        continue-on-error: true

      # SAST - Static Application Security Testing
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

      # Secret scanning
      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  # =============================================================================
  # AUTOMATED TESTING
  # =============================================================================
  
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [backend, frontend]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ matrix.service }}/package-lock.json

      - name: Install dependencies
        working-directory: ./${{ matrix.service }}
        run: npm ci --prefer-offline

      - name: Run unit tests
        working-directory: ./${{ matrix.service }}
        run: npm test -- --coverage --watchAll=false
        env:
          CI: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./${{ matrix.service }}/coverage/lcov.info
          flags: ${{ matrix.service }}
          name: ${{ matrix.service }}-coverage
          fail_ci_if_error: false

      - name: Archive test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.service }}
          path: ./${{ matrix.service }}/coverage
          retention-days: 30

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    
    services:
      # Add any service dependencies here (e.g., database, redis)
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run integration tests
        working-directory: ./backend
        run: npm run test:integration || echo "Integration tests not configured yet"
        continue-on-error: true
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          cd backend && npm ci
          cd ../frontend && npm ci

      - name: Start services with Docker Compose
        run: docker compose up -d --build

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for backend to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:4000/api/health; do sleep 2; done'
          echo "Waiting for frontend to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:80; do sleep 2; done'

      - name: Run E2E tests
        working-directory: ./frontend
        run: npm run test:e2e || echo "E2E tests not configured yet"
        continue-on-error: true

      - name: Capture logs on failure
        if: failure()
        run: docker compose logs

      - name: Stop services
        if: always()
        run: docker compose down -v

  # =============================================================================
  # BUILD & CONTAINERIZATION
  # =============================================================================
  
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, unit-tests]
    strategy:
      matrix:
        service: [backend, frontend]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Alternative: Log in to GitHub Container Registry
      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository }}/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          file: ./${{ matrix.service }}/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_VERSION=${{ env.NODE_VERSION }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository }}/${{ matrix.service }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results-${{ matrix.service }}.sarif'
          category: 'container-${{ matrix.service }}'

  # =============================================================================
  # DEPLOYMENT STAGES
  # =============================================================================
  
  deploy-development:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [build, integration-tests]
    if: github.ref == 'refs/heads/develop'
    environment:
      name: development
      url: https://dev.your-app.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to development environment
        run: |
          echo "Deploying to development..."
          # Add your deployment commands here
          # Examples:
          # - kubectl apply -f k8s/development/
          # - helm upgrade --install app ./charts/app
          # - docker compose -f docker-compose.dev.yml up -d
          # - SSH deployment
          # - Cloud provider CLI (AWS, Azure, GCP)

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          curl -f https://dev.your-app.com/api/health || exit 1

      - name: Notify deployment
        if: always()
        run: |
          echo "Development deployment completed"
          # Add Slack/Discord/Teams notification here

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build, integration-tests, e2e-tests]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/')
    environment:
      name: staging
      url: https://staging.your-app.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to staging environment
        run: |
          echo "Deploying to staging..."
          # Add your deployment commands here

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          curl -f https://staging.your-app.com/api/health || exit 1

      - name: Run performance tests
        run: |
          echo "Running performance tests..."
          # Add performance testing (e.g., k6, JMeter, Artillery)

      - name: Notify deployment
        if: always()
        run: |
          echo "Staging deployment completed"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://your-app.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment marker
        run: |
          echo "DEPLOYMENT_ID=$(date +%Y%m%d-%H%M%S)-${{ github.sha }}" >> $GITHUB_ENV

      - name: Pre-deployment backup
        run: |
          echo "Creating backup..."
          # Add database backup commands

      - name: Deploy to production (Blue-Green)
        run: |
          echo "Deploying to production..."
          # Blue-Green deployment strategy
          # 1. Deploy to green environment
          # 2. Run health checks
          # 3. Switch traffic
          # 4. Monitor

      - name: Health check
        run: |
          echo "Running health checks..."
          curl -f https://your-app.com/api/health || exit 1

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

      - name: Notify deployment success
        if: success()
        run: |
          echo "Production deployment successful!"
          # Add notification (Slack, PagerDuty, etc.)

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed! Rolling back..."
          # Add rollback commands

  # =============================================================================
  # POST-DEPLOYMENT MONITORING
  # =============================================================================
  
  post-deployment-checks:
    name: Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Monitor application health
        run: |
          echo "Monitoring application for 5 minutes..."
          for i in {1..10}; do
            curl -f https://your-app.com/api/health || exit 1
            sleep 30
          done

      - name: Check error rates
        run: |
          echo "Checking error rates in logs..."
          # Query monitoring system (Datadog, New Relic, Prometheus, etc.)

      - name: Validate metrics
        run: |
          echo "Validating application metrics..."
          # Check response times, throughput, etc.

  # =============================================================================
  # CLEANUP & MAINTENANCE
  # =============================================================================
  
  cleanup:
    name: Cleanup Resources
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()
    
    steps:
      - name: Clean up old Docker images
        run: |
          echo "Cleaning up old images..."
          # Add cleanup for container registry

      - name: Archive old artifacts
        run: |
          echo "Archiving artifacts..."
          # Move old artifacts to cold storage

      - name: Update documentation
        run: |
          echo "Updating deployment documentation..."
          # Auto-generate deployment docs
